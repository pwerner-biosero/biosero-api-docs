---
id: Query Client
title: Query Client
---

import Protected from '@site/src/components/Protected';

<Protected>

# Query Client

The `QueryClient` is the primary interface for interacting with Biosero Data Services from Python applications. This document provides comprehensive documentation for all available methods and usage patterns based on the actual implementation.

## 📋 Table of Contents

- [🔍 Overview](#-overview)
- [🏗️ Constructor](#️-constructor)
- [🆔 Identity Methods](#-identity-methods)
- [📍 Location Methods](#-location-methods)
- [📦 Container Methods](#-container-methods)
- [📏 Volume Methods](#-volume-methods)
- [📅 Event Methods](#-event-methods)
- [🔄 Workflow Methods](#-workflow-methods)
- [🛠️ Utility Methods](#️-utility-methods)
- [⚠️ Error Handling](#️-error-handling)
- [📖 Examples](#-examples)
- [🎯 Best Practices](#-best-practices)

## 🔍 Overview

The `QueryClient` class provides comprehensive methods to query and retrieve data from Biosero Data Services. It handles HTTP communication, response parsing, and data model conversion for various resource types.

**Module:** `biosero.datamodels.clients`  
**Interfaces:** Context Manager Protocol (`__enter__`, `__exit__`)

### Key Features
- Retrieve and manage identity information
- Query location and container data
- Access event history
- Retrieve workflow process information
- Search materials and samples
- Automatic resource cleanup via context manager

## 🏗️ Constructor

### QueryClient(url)

Creates a new instance of the QueryClient with the specified base URL.

**Parameters:**
- `url` (str or callable): The base URL for the API. If callable, it will be invoked to get the URL.

**Example:**
```python
# Direct URL
client = QueryClient("https://api.example.com")

# Callable URL provider
def get_api_url():
    return "https://api.example.com"

client = QueryClient(get_api_url)
```

### Context Management

The `QueryClient` supports Python's context manager protocol for automatic resource cleanup:

```python
with QueryClient("https://api.example.com") as client:
    identity = client.get_identity("item-123")
```

## 🆔 Identity Methods

Identity operations allow you to retrieve and search for devices, samples, and other resources in the system.

### get_identity(item_id)

Retrieves the identity of an item by its identifier.

**Parameters:**
- `item_id` (str): The ID of the item to retrieve the identity for

**Returns:**
- `Identity`: The identity object with properties as a `ParameterCollection`, or `None` if not found (404 response)

**Example:**
```python
client = QueryClient("https://api.example.com")
identity = client.get_identity("sample-123")
if identity:
    print(f"Identity: {identity.name}")
    print(f"Properties: {identity.properties}")
```

**API Endpoint:** `GET /api/v2.0/QueryService/Identity?id={item_id}`

### get_child_identities(parent_type_id, limit, offset)

Retrieves child identities of a parent item with pagination support.

**Parameters:**
- `parent_type_id` (str): The ID of the parent item
- `limit` (int): Maximum number of child identities to retrieve
- `offset` (int): Number of child identities to skip (for pagination)

**Returns:**
- `List[Identity]`: List of child identity objects, each with properties as a `ParameterCollection`

**Example:**
```python
children = client.get_child_identities("parent-123", limit=50, offset=0)
for child in children:
    print(f"Child: {child.name}")
```

**API Endpoint:** `GET /api/v2.0/QueryService/ChildIdentities?parentTypeId={parent_type_id}&limit={limit}&offset={offset}`

### remove_identity(item_id)

Removes an identity from the system.

**Parameters:**
- `item_id` (str): The ID of the item to remove

**Returns:**
- `bool`: `True` if successful

**Example:**
```python
success = client.remove_identity("item-to-delete")
if success:
    print("Identity removed successfully")
```

**API Endpoint:** `DELETE /api/v3.0/identities/{item_id}`

## 📍 Location Methods

Methods for retrieving location information and managing spatial relationships.

### get_location(item_id)

Retrieves the location information for a specific item.

**Parameters:**
- `item_id` (str): The ID of the item to get location for

**Returns:**
- `Location`: Location object containing position information

**Example:**
```python
location = client.get_location("container-123")
print(f"Location: {location}")
```

**API Endpoint:** `GET /api/v2.0/QueryService/Location?itemId={item_id}`

### get_items_at_location(location_id, limit, offset)

Retrieves all items present at a specific location.

**Parameters:**
- `location_id` (str): The ID of the location to query
- `limit` (int): Maximum number of items to retrieve
- `offset` (int): Number of items to skip (for pagination)

**Returns:**
- `List[Identity]`: List of Identity objects representing items at the location

**Example:**
```python
items = client.get_items_at_location("freezer-A1", limit=100, offset=0)
for item in items:
    print(f"Item at location: {item.name}")
```

**API Endpoint:** `GET /api/v2.0/QueryService/ItemsAtLocation?locationId={location_id}&limit={limit}&offset={offset}`

## 📦 Container Methods

Methods for working with containers and their contents.

### get_materials_in_container(container_id)

Retrieves all materials present in a specific container.

**Parameters:**
- `container_id` (str): The ID of the container to query

**Returns:**
- `List[MaterialInContainerSearchResult]`: List of materials in the container

**Example:**
```python
materials = client.get_materials_in_container("plate-456")
for material in materials:
    print(f"Material: {material.name}")
```

**API Endpoint:** `GET /api/v2.0/QueryService/MaterialsInContainer?containerId={container_id}`

## 📏 Volume Methods

Methods for retrieving volume measurements and calculations.

### get_net_volume(container_id)

Retrieves the net volume measurement for a container.

**Parameters:**
- `container_id` (str): The ID of the container

**Returns:**
- `Volume`: Volume measurement object

**Example:**
```python
volume = client.get_net_volume("container-789")
print(f"Net volume: {volume.value} {volume.unit}")
```

**API Endpoint:** `GET /api/v2.0/QueryService/NetVolume?containerId={container_id}`

## 📅 Event Methods

Methods for retrieving and managing system events.

### get_events(search_parameters, limit, offset)

Retrieves events based on search criteria with pagination support.

**Parameters:**
- `search_parameters`: Object containing event search criteria
- `limit` (int): Maximum number of events to retrieve
- `offset` (int): Number of events to skip (for pagination)

**Returns:**
- `List[EventMessage]`: List of event message objects, or `None` if no events found (204 response)

**Example:**
```python
# Assuming you have a search parameters object
search_params = EventSearchParameters(
    topic="sample_transfer",
    start_date="2023-01-01",
    end_date="2023-12-31"
)

events = client.get_events(search_params, limit=100, offset=0)
if events:
    for event in events:
        print(f"Event: {event.topic} at {event.created_date_utc}")
```

**API Endpoint:** `POST /api/v2.0/QueryService/Events?limit={limit}&offset={offset}`

## 🔄 Workflow Methods

Methods for retrieving workflow and process information.

### get_workflow_process(workflow_process_id)

Retrieves a workflow process by its identifier.

**Parameters:**
- `workflow_process_id` (int): The ID of the workflow process

**Returns:**
- `WorkflowProcess`: The workflow process object

**Example:**
```python
workflow = client.get_workflow_process(12345)
print(f"Workflow: {workflow.name}")
print(f"Status: {workflow.status}")
```

**API Endpoint:** `GET /api/v3.0/orders/{workflow_process_id}/workflow-processes`

## 🛠️ Utility Methods

Helper methods for data extraction and manipulation.

### get_parameter_value_from_identity(identity, parameter_name)

Helper method to retrieve a specific parameter value from an Identity object.

**Parameters:**
- `identity` (Identity): The Identity object containing parameters
- `parameter_name` (str): Name of the parameter to retrieve

**Returns:**
- `Any`: The parameter value if found, otherwise `None`

**Example:**
```python
identity = client.get_identity("sample-123")
volume = client.get_parameter_value_from_identity(identity, "Volume")
concentration = client.get_parameter_value_from_identity(identity, "Concentration")
print(f"Sample volume: {volume}, concentration: {concentration}")
```

## ⚠️ Error Handling

The Query Client implements several error handling strategies:

### HTTP Status Codes
Methods raise exceptions for HTTP errors using `response.raise_for_status()`

### Specific Error Handling
- **404 Handling**: `get_identity()` returns `None` for 404 responses instead of raising an exception
- **Empty Results**: `get_events()` returns `None` for 204 (No Content) responses

### Example Error Handling
```python
try:
    identity = client.get_identity("item-123")
    if identity is None:
        print("Item not found")
    else:
        print(f"Found item: {identity.name}")
except requests.exceptions.RequestException as e:
    print(f"Network error: {e}")
```

## 📖 Examples

### Complete Workflow Example
```python
from biosero.datamodels.clients import QueryClient

# Initialize client
with QueryClient("https://api.example.com") as client:
    try:
        # Get identity information
        identity = client.get_identity("sample-123")
        if identity:
            print(f"Processing sample: {identity.name}")
            
            # Get location
            location = client.get_location("sample-123")
            print(f"Sample location: {location}")
            
            # Get container contents if it's a container
            if hasattr(identity, 'is_container') and identity.is_container:
                materials = client.get_materials_in_container("sample-123")
                print(f"Contains {len(materials)} materials")
                
                # Get volume information
                volume = client.get_net_volume("sample-123")
                print(f"Net volume: {volume.value} {volume.unit}")
            
            # Query recent events
            events = client.get_events(search_params, limit=10, offset=0)
            if events:
                print(f"Found {len(events)} recent events")
                
    except Exception as e:
        print(f"Error occurred: {e}")
```

### Pagination Example
```python
def get_all_children(client, parent_id):
    """Retrieve all child identities using pagination"""
    all_children = []
    offset = 0
    limit = 100
    
    while True:
        children = client.get_child_identities(parent_id, limit, offset)
        if not children:
            break
        all_children.extend(children)
        offset += limit
    
    return all_children

# Usage
with QueryClient("https://api.example.com") as client:
    all_children = get_all_children(client, "parent-123")
    print(f"Total children found: {len(all_children)}")
```

## 🎯 Best Practices

### 1. Use Context Managers
Always use the client within a context manager to ensure proper cleanup:

```python
with QueryClient("https://api.example.com") as client:
    # Your operations here
    pass
```

### 2. Handle Pagination
For methods that support pagination, implement proper pagination logic:

```python
def get_all_items_at_location(client, location_id):
    all_items = []
    offset = 0
    limit = 100
    
    while True:
        items = client.get_items_at_location(location_id, limit, offset)
        if not items:
            break
        all_items.extend(items)
        offset += limit
    
    return all_items
```

### 3. Error Handling
Implement proper error handling for network and API errors:

```python
try:
    identity = client.get_identity("item-123")
    if identity is None:
        print("Item not found")
    else:
        print(f"Found item: {identity.name}")
except requests.exceptions.RequestException as e:
    print(f"Network error: {e}")
```

### 4. Parameter Extraction
Use the helper method for safe parameter extraction:

```python
identity = client.get_identity("sample-123")
volume = client.get_parameter_value_from_identity(identity, "Volume")
concentration = client.get_parameter_value_from_identity(identity, "Concentration")
```

### 5. Performance Considerations
- **Session Reuse**: The client reuses HTTP connections through the internal session
- **Pagination**: Use appropriate page sizes to balance memory usage and network efficiency
- **Caching**: Consider implementing client-side caching for frequently accessed, static data
- **Connection Pooling**: The underlying requests session provides connection pooling automatically

## 🔗 Related Data Models

The Query Client works with several data models from the `biosero.datamodels` package:

- **Identity**: Represents an item's identity with properties as a `ParameterCollection`
- **EventMessage**: Represents system events with metadata
- **Location**: Represents spatial location information
- **Volume/Weight**: Represents measurement data
- **WorkflowProcess**: Represents workflow execution information
- **MaterialInContainerSearchResult**: Represents materials found in containers
- **Parameter/ParameterCollection**: Represents item properties and metadata

## 🧵 Thread Safety

The `QueryClient` uses a `requests.Session` object internally. While `requests.Session` is generally thread-safe for reading operations, it's recommended to create separate client instances for different threads when performing write operations.

</Protected>
